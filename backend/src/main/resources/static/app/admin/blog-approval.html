<!doctype html>

<html lang="vi">

<head>

  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Duyệt blog cộng đồng</title>

  <link rel="stylesheet" href="/app/app.css"/>

  <style>

    .blog-table tr:hover { background-color: rgba(255,255,255,0.02); }

    .status-chip { display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:.04em; text-transform:uppercase; }

    .status-chip.pending { background:#fbbf24; color:#1f2937; }

    .status-chip.draft { background:#e5e7eb; color:#111827; }

    .status-chip.published { background:#34d399; color:#0f172a; }

    .status-chip.rejected { background:#f87171; color:#0f172a; }

    .detail-box { border:1px solid rgba(255,255,255,0.08); border-radius:24px; padding:16px; background:rgba(15,23,42,0.45); min-height:360px; }

    .detail-box h3 { margin:0; font-size:20px; }

    .detail-box .meta { font-size:13px; color:#cbd5f5; margin:4px 0 16px; }

    .detail-content { max-height:400px; overflow:auto; padding-right:8px; }

    .detail-content p { line-height:1.6; margin-bottom:12px; }

    .btn.small { padding:6px 10px; font-size:13px; }

    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px; }

    .empty-state { border:1px dashed rgba(255,255,255,0.2); padding:24px; text-align:center; border-radius:20px; color:#cbd5f5; }

    .blog-table td.actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }

    .blog-table td.actions .btn { min-width:0; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.65); display:none; align-items:center; justify-content:center; z-index:40; padding:24px; }
    .modal-backdrop.open { display:flex; }
    .modal-panel { width:min(760px, 95vw); background:rgba(255,255,255,0.97); border-radius:28px; padding:24px; border:1px solid rgba(0,0,0,0.08); box-shadow:0 30px 80px rgba(0,0,0,0.25); color:#1f2937; max-height:85vh; overflow:hidden; display:flex; flex-direction:column; gap:16px; }
    .modal-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .modal-header h2 { margin:0; font-size:1.4rem; color:#0f172a; }
    .modal-body { flex:1; overflow:auto; border:1px solid rgba(0,0,0,0.08); border-radius:20px; padding:12px; background:rgba(249,250,251,0.8); }
    .modal-list-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 6px; border-bottom:1px solid rgba(15,23,42,0.08); }
    .modal-list-row:last-child { border-bottom:none; }
    .modal-meta { display:flex; flex-direction:column; gap:2px; }
    .modal-meta strong { font-size:0.95rem; color:#111827; }
    .modal-meta span { font-size:0.82rem; color:#6b7280; }

  </style>

  <script type="module">

    import { mountNav, mountAdminMenu, mountAdminUser, requireAuth, api } from '/app/app-common.js';



    const state = {

      posts: [],

      selected: null,

      detail: null,

    };

    const modalRefs = { root: null, list: null };




    window.addEventListener('DOMContentLoaded', () => {

      if (!requireAuth(['MANAGER'])) return;

      mountNav('nav', 'compact');

      mountAdminMenu('adminMenu', 'blog-approval');

      mountAdminUser('adminUserCard');

      document.getElementById('btnRefresh').addEventListener('click', loadPosts);

      document.getElementById('btnOpenModal').addEventListener('click', openModalList);

      modalRefs.root = document.getElementById('listingModal');
      modalRefs.list = document.getElementById('modalPostList');

      modalRefs.root?.addEventListener('click', (evt) => {
        if (evt.target === modalRefs.root) closeModalList();
      });

      document.querySelectorAll('[data-close-modal]').forEach((el) => el.addEventListener('click', closeModalList));

      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && modalRefs.root?.classList.contains('open')) {
          closeModalList();
        }
      });

      loadPosts();

    });



    async function loadPosts() {

      renderList(true);

      try {

        const data = await api('/api/admin/blog/pending');

        state.posts = Array.isArray(data) ? data : [];

        if (!state.posts.length) {

          state.selected = null;

          state.detail = null;

        }

        renderList(false);

        renderModalList();

      } catch (error) {

        document.getElementById('blogBody').innerHTML =

          `<tr><td colspan="6">Không thể tải dữ liệu: ${error?.message || error}</td></tr>`;

      }

    }



    function renderList(isLoading = false) {

      const body = document.getElementById('blogBody');

      if (isLoading) {

        body.innerHTML = '<tr><td colspan="6">Đang tải...</td></tr>';

        return;

      }

      if (!state.posts.length) {

        body.innerHTML = '<tr><td colspan="6">Chưa có bài viết chờ duyệt.</td></tr>';

        renderDetail();

        return;

      }

      body.innerHTML = state.posts

        .map(

          (post) => `

          <tr data-id="${post.id}">

            <td>#${post.id}</td>

            <td>

              <div class="title">${post.title || ''}</div>

              <small class="muted">${post.slug || ''}</small>

            </td>

            <td>${post.authorName || ''}</td>

            <td>${formatDate(post.submittedAt || post.createdAt)}</td>

            <td><span class="status-chip ${post.status || ''}">${(post.status || '').toUpperCase()}</span></td>

            <td class="actions">

              <button class="btn xs" data-action="view" data-id="${post.id}">Xem</button>

              <button class="btn xs ghost" data-action="approve" data-id="${post.id}">Duyệt</button>

              <button class="btn xs danger" data-action="reject" data-id="${post.id}">Từ chối</button>

              <button class="btn xs ghost danger" data-action="delete" data-id="${post.id}">X&#243;a</button>

            </td>

          </tr>`,

        )

        .join('');



      body.querySelectorAll('button[data-action]').forEach((btn) => {

        btn.addEventListener('click', () => handleRowAction(btn.dataset.id, btn.dataset.action));

      });



      // auto-select first if nothing chosen

      if (!state.selected && state.posts.length) {

        selectPost(state.posts[0]);

      }

      renderModalList();

    }



    function formatDate(value) {

      if (!value) return '--';

      try {

        return new Date(value).toLocaleString('vi-VN');

      } catch {

        return value;

      }

    }



    async function handleRowAction(id, action) {

      if (action === 'view') {

        const post = state.posts.find((p) => String(p.id) === String(id));

        if (post) await selectPost(post);

        return;

      }

      if (action === 'approve') {

        if (!confirm('Duyệt bài viết này?')) return;

        await mutatePost(id, 'approve');

        return;

      }

      if (action === 'reject') {

        const reason = prompt('Nhập lý do từ chối (tuỳ chọn):', '');

        await mutatePost(id, 'reject', reason ? { reason } : null);

        return;

      }

      if (action === 'delete') {

        if (!confirm('X\u00f3a b\u00e0i vi\u1ebft n\u00e0y? H\u00e0nh \u0111\u1ed9ng kh\u00f4ng th\u1ec3 ho\u00e0n t\u00e1c.')) return;

        await mutatePost(id, 'delete');

        renderModalList();

        return;

      }

    }



    async function selectPost(post) {

      state.selected = post;

      renderDetail(true);

      try {

        const data = await api(`/api/admin/blog/${post.id}`);

        state.detail = data;

      } catch (error) {

        state.detail = { error: error?.message || 'Không thể tải chi tiết.' };

      }

      renderDetail(false);

    }



    function renderDetail(loading = false) {

      const host = document.getElementById('detailPanel');

      if (loading) {

        host.innerHTML = '<p class="muted">Đang tải chi tiết...</p>';

        return;

      }

      if (!state.selected) {

        host.innerHTML = '<div class="empty-state">Chọn một bài viết bên trái để xem nội dung chi tiết.</div>';

        return;

      }

      if (state.detail?.error) {

        host.innerHTML = `<div class="empty-state">${state.detail.error}</div>`;

        return;

      }

      const post = state.detail || state.selected;

      const contentHtml = (post.content || '').split(/\\n+/).map((line) => `<p>${line}</p>`).join('');

      host.innerHTML = `

        <div class="detail-box">

          <h3>${post.title || ''}</h3>

          <div class="meta">

            <div>Tác giả: <strong>${post.authorName || 'Không rõ'}</strong></div>

            <div>Gửi lúc: ${formatDate(post.submittedAt || post.createdAt)}</div>

            ${post.rejectionReason ? `<div>Lý do gần nhất: ${post.rejectionReason}</div>` : ''}

          </div>

          <p class="muted">${post.summary || 'Không có mô tả ngắn.'}</p>

          <div class="detail-content">${contentHtml || '<p>Chưa có nội dung.</p>'}</div>

        </div>

      `;

    }



    async function mutatePost(id, action, payload) {

      const isDelete = action === 'delete';

      const requestInit = { method: isDelete ? 'DELETE' : 'POST' };

      if (payload) {

        requestInit.body = JSON.stringify(payload);

      }

      const path = isDelete ? `/api/admin/blog/${id}` : `/api/admin/blog/${id}/${action}`;

      try {

        await api(path, requestInit);

        state.posts = state.posts.filter((post) => String(post.id) !== String(id));

        if (state.selected && String(state.selected.id) === String(id)) {

          state.selected = null;

          state.detail = null;

        }

        renderList(false);

      } catch (error) {

        alert(error?.message || `Không thể ${action} bài viết.`);

      }

    }


    async function openModalList() {

      if (!modalRefs.root) return;

      modalRefs.root.classList.add('open');

      modalRefs.root.removeAttribute('aria-hidden');

      if (!state.posts.length) {

        renderModalList(true);

        await loadPosts();

      }

      renderModalList();

    }

    function closeModalList() {

      if (!modalRefs.root) return;

      modalRefs.root.classList.remove('open');

      modalRefs.root.setAttribute('aria-hidden', 'true');

    }

    function renderModalList(isLoading = false) {

      if (!modalRefs.list) return;

      if (isLoading) {

        modalRefs.list.innerHTML = '<p class="muted">?ang t?i danh s?ch...</p>';

        return;

      }

      if (!state.posts.length) {

        modalRefs.list.innerHTML = '<div class="empty-state">Hi?n ch?a c? b?i vi?t n?o trong h?ng ch?.</div>';

        return;

      }

      modalRefs.list.innerHTML = state.posts

        .map(

          (post) => `

            <div class="modal-list-row">

              <div class="modal-meta">

                <strong>${post.title || 'Kh?ng ti?u ??'}</strong>

                <span>${post.authorName || '---'} ? ${formatDate(post.submittedAt || post.createdAt)}</span>

              </div>

              <button class="btn xs ghost danger" data-modal-delete='${post.id}'>X&#243;a</button>

            </div>

          `,

        )

        .join('');

      modalRefs.list.querySelectorAll('[data-modal-delete]').forEach((btn) => {

        btn.addEventListener('click', async () => {

          const id = btn.getAttribute('data-modal-delete');

          if (!id) return;

          if (!confirm('B?n ch?c ch?n mu?n x?a b?i vi?t n?y?')) return;

          await mutatePost(id, 'delete');

        });

      });

    }

  </script>

</head>

<body class="admin-body">

  <div class="admin-shell">

    <aside class="admin-sidebar">

      <div class="admin-brand">

        <span class="eyebrow">Cộng đồng</span>

        <strong>Duyệt blog</strong>

        <p class="muted">Quản lý bài viết sinh viên, duyệt trước khi xuất bản.</p>

      </div>

      <div id="adminUserCard" class="admin-user-card"></div>

      <nav id="adminMenu" class="admin-menu"></nav>

      <div class="admin-sidebar-footer">

        <a class="text-link" href="/app/index.html">← Về trang tổng quan</a>

      </div>

    </aside>

    <div class="admin-main">

      <div id="nav" data-variant="compact"></div>

      <main class="admin-content">

        <div class="card">

          <div class="flex-between" style="gap:12px; flex-wrap:wrap;">

            <div>

              <h1>Danh sách bài viết</h1>

              <span class="muted small">Duyệt / từ chối các bài viết cộng đồng</span>

            </div>

            <div class="toolbar">

              <button id="btnOpenModal" class="btn secondary">Xem nhanh</button>

              <button id="btnRefresh" class="btn ghost">Làm mới</button>

            </div>

          </div>

          <div class="grid gap-6 lg:grid-cols-[1.2fr,0.8fr]">

            <div class="table-responsive">

              <table class="table blog-table">

                <thead>

                  <tr><th>ID</th><th>Tiêu đề</th><th>Tác giả</th><th>Gửi lúc</th><th>Trạng thái</th><th>Thao tác</th></tr>

                </thead>

                <tbody id="blogBody"></tbody>

              </table>

            </div>

            <section id="detailPanel" class="detail-box">

              <div class="empty-state">Chọn một bài viết để xem nội dung và duyệt.</div>

            </section>

          </div>

        </div>

      </main>

    </div>

  </div>

  <div id="listingModal" class="modal-backdrop" aria-hidden="true">

    <div class="modal-panel" role="dialog" aria-modal="true">

      <div class="modal-header">

        <div>

          <h2>Danh s?ch b?i vi?t ch? duy?t</h2>

          <p class="muted small">X?a nhanh c?c b?i vi?t kh?ng h?p l? ngay t?i ??y.</p>

        </div>

        <button class="btn ghost small" data-close-modal>??ng</button>

      </div>

      <div id="modalPostList" class="modal-body">

        <p class="muted">?ang t?i...</p>

      </div>

    </div>

  </div>

</body>

</html>